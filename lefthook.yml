# Lefthook - Git Hooks Manager
# https://github.com/evilmartians/lefthook
#
# Install: brew install lefthook && lefthook install

pre-commit:
  commands:
    dprint-check:
      glob: "**/*.{md,json,yml,yaml}"
      run: dprint check {staged_files}

    brew-style:
      glob: "Formula/*.rb"
      run: brew style {staged_files}

    brew-audit:
      glob: "Formula/*.rb"
      # NOTE: `brew audit [path]` is disabled, must use formula names from a tap.
      # Workaround: create a temporary tap and copy formulas for auditing.
      # See: https://github.com/orgs/Homebrew/discussions/4864
      # See: https://github.com/orgs/Homebrew/discussions/4243
      run: |
        # Create temporary tap for auditing local formulas
        brew tap-new --no-git lefthook/audit 2>/dev/null || true
        TAP_DIR="$(brew --repository lefthook/audit)/Formula"
        mkdir -p "$TAP_DIR"
        trap "brew untap lefthook/audit 2>/dev/null || true" EXIT
        exit_code=0
        for f in {staged_files}; do
          name=$(basename "$f")
          formula=$(basename "$name" .rb)
          cp "$f" "$TAP_DIR/$name"
          if ! brew audit --formula "lefthook/audit/$formula"; then
            exit_code=1
          fi
        done
        exit $exit_code

    workflow-lint:
      glob: ".github/workflows/*.{yml,yaml}"
      run: ghalint run -c tools/lint/ghalint.yaml
      fail_text: "Fix GitHub Actions workflow issues"

    workflow-pin:
      glob: ".github/workflows/*.{yml,yaml}"
      run: pinact run --verify -c tools/lint/pinact.yaml
      fail_text: "Run 'pinact run -u -c tools/lint/pinact.yaml' to pin action versions"

commit-msg:
  commands:
    conventional-commit:
      run: |
        commit_msg=$(head -n1 {1})
        if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?!?: .+$"; then
          echo "Error: Commit message does not follow conventional commits format."
          echo "Example: feat(bazelle): update formula to v0.2.0"
          exit 1
        fi
